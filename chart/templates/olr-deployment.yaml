apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-olr
  labels:
    app: {{ .Release.Name }}-olr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ .Release.Name }}-olr
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-olr
    spec:
      securityContext:
        # OLR needs oinstall group (54321) to read redo logs
        supplementalGroups: [54321]
      initContainers:
        # Fix permissions on checkpoint and output volumes
        - name: fix-permissions
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /checkpoint
              mkdir -p /output/swap && chown -R 1000:1000 /output
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: checkpoint
              mountPath: /checkpoint
            - name: output
              mountPath: /output
        # Wait for Oracle to be ready
        - name: wait-for-oracle
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z {{ .Release.Name }}-oracle 1521; do echo waiting for oracle; sleep 5; done']
      containers:
        - name: olr
          image: "{{ .Values.olr.image.repository }}:{{ .Values.olr.image.tag }}"
          imagePullPolicy: {{ .Values.olr.image.pullPolicy }}
          ports:
            - containerPort: 9000
              name: network
            - containerPort: 9161
              name: metrics
          resources:
            {{- toYaml .Values.olr.resources | nindent 12 }}
          volumeMounts:
            # Read-only access to Oracle redo logs
            - name: oracle-oradata
              mountPath: /opt/oracle/oradata
              readOnly: true
            - name: config
              mountPath: /opt/OpenLogReplicator/scripts/OpenLogReplicator.json
              subPath: OpenLogReplicator.json
            - name: checkpoint
              mountPath: /opt/OpenLogReplicator/checkpoint
            - name: output
              mountPath: /output
      volumes:
        - name: oracle-oradata
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-oracle-oradata
        - name: config
          configMap:
            name: {{ .Release.Name }}-olr-config
        - name: checkpoint
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-olr-checkpoint
        - name: output
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-olr-output
