apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-debezium-config
  labels:
    app: {{ .Release.Name }}-debezium
data:
  application.properties: |
    # Debezium Server Configuration for Oracle to File
    # Uses HTTP sink with a simple file-writer service

    # ============================================
    # Sink Configuration (HTTP -> File Writer)
    # ============================================
    debezium.sink.type=http
    debezium.sink.http.url=http://{{ .Release.Name }}-file-writer:{{ .Values.fileWriter.port }}/events
    debezium.sink.http.timeout.ms=5000

    # ============================================
    # Format Configuration
    # ============================================
    debezium.format.key=json
    debezium.format.value=json
    debezium.format.value.schemas.enable=false

    # ============================================
    # Source Configuration (Oracle with LogMiner)
    # ============================================
    debezium.source.connector.class=io.debezium.connector.oracle.OracleConnector
    debezium.source.database.hostname={{ .Release.Name }}-oracle
    debezium.source.database.port={{ .Values.debezium.oracle.port }}
    debezium.source.database.user={{ .Values.debezium.oracle.user }}
    debezium.source.database.password={{ .Values.debezium.oracle.password }}
    debezium.source.database.dbname={{ .Values.debezium.oracle.dbname }}
    debezium.source.database.pdb.name={{ .Values.debezium.oracle.pdbName }}
    debezium.source.topic.prefix={{ .Values.debezium.topicPrefix }}

    # LogMiner configuration
    debezium.source.database.connection.adapter=logminer
    debezium.source.log.mining.strategy=online_catalog

    # Tables to capture
    debezium.source.schema.include.list={{ .Values.debezium.schemaIncludeList }}
    debezium.source.table.include.list={{ .Values.debezium.tableIncludeList }}

    # Offset storage
    debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
    debezium.source.offset.flush.interval.ms=10000

    # Schema history storage
    debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
    debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat

    # Snapshot mode
    debezium.source.snapshot.mode={{ .Values.debezium.snapshotMode }}

    {{- if .Values.debezium.smt.enabled }}
    # ============================================
    # SMT Configuration (Legacy Charset Transform)
    # ============================================
    debezium.transforms=legacycharset
    debezium.transforms.legacycharset.type=com.example.debezium.smt.LegacyCharsetTransform
    debezium.transforms.legacycharset.encoding={{ .Values.debezium.smt.encoding }}
    debezium.transforms.legacycharset.columns={{ .Values.debezium.smt.columns }}
    debezium.transforms.legacycharset.tables={{ .Values.debezium.smt.tables }}
    {{- end }}
