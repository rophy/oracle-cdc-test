{{- if eq .Values.mode "full" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-debezium-config
  labels:
    app: {{ .Release.Name }}-debezium
data:
  application.properties: |
    # Debezium Server Configuration for Oracle via OpenLogReplicator
    # Uses Kafka sink

    # ============================================
    # Sink Configuration (Kafka)
    # ============================================
    debezium.sink.type=kafka
    debezium.sink.kafka.producer.bootstrap.servers={{ .Release.Name }}-kafka:9092
    debezium.sink.kafka.producer.key.serializer=org.apache.kafka.common.serialization.StringSerializer
    debezium.sink.kafka.producer.value.serializer=org.apache.kafka.common.serialization.StringSerializer

    # ============================================
    # Format Configuration
    # ============================================
    debezium.format.key=json
    debezium.format.value=json
    debezium.format.value.schemas.enable=false

    # ============================================
    # Source Configuration (Oracle with OpenLogReplicator)
    # ============================================
    debezium.source.connector.class=io.debezium.connector.oracle.OracleConnector
    debezium.source.database.hostname={{ .Release.Name }}-oracle
    debezium.source.database.port={{ .Values.debezium.oracle.port }}
    debezium.source.database.user={{ .Values.debezium.oracle.user }}
    debezium.source.database.password={{ .Values.debezium.oracle.password }}
    debezium.source.database.dbname={{ .Values.debezium.oracle.dbname }}
    debezium.source.database.pdb.name={{ .Values.debezium.oracle.pdbName }}
    debezium.source.topic.prefix={{ .Values.debezium.topicPrefix }}

    # OpenLogReplicator adapter configuration
    debezium.source.database.connection.adapter=olr
    debezium.source.openlogreplicator.source=ORACLE
    debezium.source.openlogreplicator.host={{ .Release.Name }}-olr
    debezium.source.openlogreplicator.port=9000

    # Tables to capture
    debezium.source.schema.include.list={{ .Values.debezium.schemaIncludeList }}

    # Offset storage
    debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
    debezium.source.offset.flush.interval.ms=10000

    # Schema history storage
    debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
    debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat

    # Snapshot mode
    debezium.source.snapshot.mode={{ .Values.debezium.snapshotMode }}

    # Skip schema changes to avoid crashes when encountering unknown tables
    debezium.source.include.schema.changes=false
    debezium.source.schema.history.internal.store.only.captured.tables.ddl=true
{{- end }}
