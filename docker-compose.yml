services:
  # Init container to fix Oracle volume permissions (Oracle runs as UID 54321)
  oracle-init:
    image: busybox:1.36
    # Fix ownership AND make oradata world-readable for OpenLogReplicator
    command: ["sh", "-c", "chown -R 54321:54321 /opt/oracle/oradata && chmod -R o+rX /opt/oracle/oradata"]
    volumes:
      - oracle-oradata:/opt/oracle/oradata
    restart: "no"

  oracle:
    image: gvenzl/oracle-free:23.9-slim-faststart
    depends_on:
      oracle-init:
        condition: service_completed_successfully
    environment:
      - ORACLE_PASSWORD=${ORACLE_PASSWORD:-OraclePwd123}
    volumes:
      - oracle-oradata:/opt/oracle/oradata
      - ./config/oracle/01_startup.sh:/container-entrypoint-startdb.d/01_startup.sh:ro
      - ./config/oracle/setup.sql.template:/container-entrypoint-startdb.d/setup.ddl:ro
    healthcheck:
      # Check that the c##dbzuser exists (created by setup script)
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -S c##dbzuser/dbzpwd@//localhost:1521/FREE"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 180s
    deploy:
      resources:
        limits:
          memory: 8G
    networks:
      - cdc-network

  prometheus:
    image: prom/prometheus:v2.47.0
    volumes:
      - ./config/prometheus/prometheus-olr-only.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - cdc-network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - cdc-network

  # Init container to fix OLR checkpoint volume permissions (OLR runs as UID 54321)
  olr-init:
    image: busybox:1.36
    command: ["sh", "-c", "chown -R 54321:54321 /checkpoint /output"]
    volumes:
      - olr-checkpoint:/checkpoint
      - ./output:/output
    restart: "no"

  # OpenLogReplicator - writes directly to file (no Debezium)
  olr:
    build: ./olr
    depends_on:
      olr-init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
    volumes:
      - oracle-oradata:/opt/oracle/oradata:ro
      - ./config/openlogreplicator/OpenLogReplicator-file.json:/opt/OpenLogReplicator/scripts/OpenLogReplicator.json:ro
      - olr-checkpoint:/opt/OpenLogReplicator/checkpoint
      - ./output:/output
    networks:
      - cdc-network

  hammerdb:
    image: tpcorg/hammerdb:v4.10
    profiles:
      - hammerdb
    depends_on:
      oracle:
        condition: service_healthy
    environment:
      - LD_LIBRARY_PATH=/home/instantclient_21_5
      - ORACLE_LIBRARY=/home/instantclient_21_5/libclntsh.so
      - ORACLE_HOST=oracle
      - ORACLE_PORT=1521
      - ORACLE_SERVICE=FREEPDB1
    volumes:
      - ./config/hammerdb:/scripts:ro
      - ./output/hammerdb:/output
    stdin_open: true
    tty: true
    entrypoint: ["/scripts/entrypoint.sh"]
    command: ["shell"]
    networks:
      - cdc-network

volumes:
  oracle-oradata:
  prometheus-data:
  olr-checkpoint:

networks:
  cdc-network:
    driver: bridge
