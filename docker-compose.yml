services:
  # Init container to fix Oracle volume permissions (Oracle runs as UID 54321)
  oracle-init:
    image: busybox:1.36
    # Fix ownership AND make both oradata and FRA world-readable for OpenLogReplicator
    command: ["sh", "-c", "chown -R 54321:54321 /opt/oracle/oradata /opt/oracle/fra && chmod -R o+rX /opt/oracle/fra /opt/oracle/oradata"]
    volumes:
      - oracle-oradata:/opt/oracle/oradata
      - oracle-fra:/opt/oracle/fra
    restart: "no"

  oracle:
    image: container-registry.oracle.com/database/free:23.5.0.0-lite
    depends_on:
      oracle-init:
        condition: service_completed_successfully
    environment:
      - ORACLE_PWD=${ORACLE_PWD:-OraclePwd123}
      - ORACLE_CHARACTERSET=US7ASCII
    volumes:
      - oracle-oradata:/opt/oracle/oradata
      - oracle-fra:/opt/oracle/fra
      - ./config/oracle/01_startup.sh:/opt/oracle/scripts/startup/01_startup.sh:ro
      - ./config/oracle/setup.sql.template:/opt/oracle/scripts/startup/setup.ddl:ro
    healthcheck:
      # Check that the c##dbzuser exists (created by setup script)
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -S c##dbzuser/dbzpwd@//localhost:1521/FREE"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 180s
    deploy:
      resources:
        limits:
          memory: 8G
    networks:
      - cdc-network

  file-writer:
    image: python:3.11-slim
    command: python /app/file-writer.py
    volumes:
      - ./config/file-writer/file-writer.py:/app/file-writer.py:ro
      - file-writer-output:/app/output
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/')\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - cdc-network

  # Init container to fix Debezium volume permissions (Debezium runs as UID 185)
  debezium-init:
    image: busybox:1.36
    command: ["sh", "-c", "chown -R 185:185 /debezium/data && chmod 755 /debezium/data"]
    volumes:
      - debezium-data:/debezium/data
    restart: "no"

  jmx-exporter:
    image: sscaling/jmx-prometheus-exporter:0.12.0
    depends_on:
      - dbz
    environment:
      - SERVICE_PORT=9404
      - CONFIG_YML=/etc/jmx-exporter/config.yaml
    volumes:
      - ./config/jmx-exporter/config.yaml:/etc/jmx-exporter/config.yaml:ro
    networks:
      - cdc-network

  prometheus:
    image: prom/prometheus:v2.47.0
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - cdc-network

  # Init container to fix OLR volume permissions (OLR runs as UID 1000)
  olr-init:
    image: busybox:1.36
    command: ["sh", "-c", "chown -R 1000:1000 /checkpoint"]
    volumes:
      - olr-checkpoint:/checkpoint
    restart: "no"

  # OpenLogReplicator - reads redo logs directly for Debezium OLR adapter
  olr:
    image: rophy/openlogreplicator:1.8.7
    depends_on:
      olr-init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
    volumes:
      - oracle-oradata:/opt/oracle/oradata:ro
      - oracle-fra:/opt/oracle/fra:ro
      - ./config/openlogreplicator/OpenLogReplicator.json:/opt/OpenLogReplicator/scripts/OpenLogReplicator.json:ro
      - olr-checkpoint:/opt/OpenLogReplicator/checkpoint
    networks:
      - cdc-network

  # Debezium with OpenLogReplicator backend
  dbz:
    image: quay.io/debezium/server:3.3.2.Final
    restart: on-failure
    depends_on:
      debezium-init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
      file-writer:
        condition: service_healthy
      olr:
        condition: service_started
    environment:
      - JAVA_OPTS=-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=1099 -Dcom.sun.management.jmxremote.rmi.port=1099 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=dbz
    volumes:
      - ./config/debezium/application-olr.properties:/debezium/config/application.properties:ro
      - debezium-data:/debezium/data
    networks:
      - cdc-network

  hammerdb:
    image: tpcorg/hammerdb:v4.10
    depends_on:
      oracle:
        condition: service_healthy
    environment:
      - LD_LIBRARY_PATH=/home/instantclient_21_5
      - ORACLE_LIBRARY=/home/instantclient_21_5/libclntsh.so
      - ORACLE_HOST=oracle
      - ORACLE_PORT=1521
      - ORACLE_SERVICE=FREEPDB1
    volumes:
      - ./config/hammerdb:/scripts:ro
    stdin_open: true
    tty: true
    entrypoint: ["/scripts/entrypoint.sh"]
    command: ["shell"]
    networks:
      - cdc-network

volumes:
  oracle-oradata:
  oracle-fra:
  debezium-data:
  file-writer-output:
  prometheus-data:
  olr-checkpoint:

networks:
  cdc-network:
    driver: bridge
