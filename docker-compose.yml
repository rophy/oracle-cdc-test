services:
  # Autoheal: monitors and restarts unhealthy containers
  autoheal:
    image: willfarrell/autoheal:1.2.0
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=30

  # Cleanup service - run with: docker compose --profile=clean run --rm clean
  clean:
    image: busybox:1.36
    profiles: ["clean"]
    command: ["sh", "-c", "rm -rf /olr/* /output/hammerdb/* /output/kafka-consumer/*"]
    volumes:
      - olr:/olr
      - hammerdb-output:/output/hammerdb
      - kafka-consumer-output:/output/kafka-consumer

  # Init container to fix volume permissions
  init:
    image: busybox:1.36
    command:
      - "sh"
      - "-c"
      - |
          set -xe
          chown -R 54321:54321 /opt/oracle/oradata
          chown -R 1000:1000 /output/hammerdb
          mkdir -p /olr/checkpoint /olr/swap /olr/output && chown -R 1000:1000 /olr
    volumes:
      - oracle-oradata:/opt/oracle/oradata
      - hammerdb-output:/output/hammerdb
      - olr:/olr
    restart: "no"

  oracle:
    image: gvenzl/oracle-free:23.9-slim-faststart
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      - ORACLE_PASSWORD=${ORACLE_PASSWORD:-OraclePwd123}
    volumes:
      - oracle-oradata:/opt/oracle/oradata
      - ./config/oracle/01_startup.sh:/container-entrypoint-startdb.d/01_startup.sh:ro
      - ./config/oracle/setup.sql.template:/container-entrypoint-startdb.d/setup.ddl:ro
    healthcheck:
      # Check that the c##dbzuser exists (created by setup script)
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -S c##dbzuser/dbzpwd@//localhost:1521/FREE"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 180s
    deploy:
      resources:
        limits:
          memory: 8G
    networks:
      - cdc-network

  prometheus:
    image: prom/prometheus:v2.47.0
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - cdc-network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - cdc-network

  # Oracle database metrics exporter
  oracle-exporter:
    image: container-registry.oracle.com/database/observability-exporter:2.2.0
    restart: on-failure
    depends_on:
      oracle:
        condition: service_healthy
    command:
      - --config.file=/exporter/config.yaml
    volumes:
      - ./config/oracle-exporter:/exporter:ro
    networks:
      - cdc-network
    labels:
      - autoheal=true
    # Healthcheck: autoheal restarts container if oracledb_up metric is 0
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9161/metrics | grep -q 'oracledb_up{database=\"default\"} 1'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hammerdb:
    build: ./hammerdb
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      - TMP=/tmp
      - LD_LIBRARY_PATH=/home/instantclient_21_5
      - ORACLE_LIBRARY=/home/instantclient_21_5/libclntsh.so
      - ORACLE_HOST=oracle
      - ORACLE_PORT=1521
      - ORACLE_SERVICE=FREEPDB1
      - ORACLE_USER=system
      - ORACLE_PASSWORD=${ORACLE_PASSWORD:-OraclePwd123}
      - ORACLE_INSTANCE=oracle:1521/FREEPDB1
      - HAMMERDB_VUS=${HAMMERDB_VUS:-8}
    volumes:
      - ./config/hammerdb:/scripts
      - hammerdb-output:/tmp
    entrypoint: ["/scripts/entrypoint.sh"]
    command: ["web"]
    networks:
      - cdc-network

  #############################################################################
  # Profile: olr-only
  # OpenLogReplicator writes directly to file (no Debezium/Kafka)
  # Usage: docker compose --profile=olr-only up -d
  #############################################################################

  olr-file:
    build: ./olr
    profiles: ["olr-only"]
    depends_on:
      init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
    volumes:
      - oracle-oradata:/opt/oracle/oradata:ro
      - ./config/openlogreplicator/OpenLogReplicator-file.json:/opt/OpenLogReplicator/scripts/OpenLogReplicator.json:ro
      - olr:/olr
    networks:
      cdc-network:
        aliases:
          - olr

  #############################################################################
  # Profile: full
  # Full CDC pipeline: OLR -> Debezium -> Kafka -> kafka-consumer
  # Usage: docker compose --profile=full up -d
  #############################################################################

  kafka:
    image: apache/kafka:3.9.0
    profiles: ["full"]
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - cdc-network

  kafka-consumer:
    image: python:3.11-slim
    profiles: ["full"]
    command: sh -c "pip install kafka-python-ng && python /app/kafka-consumer.py"
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC_PATTERN=oracle.*
    volumes:
      - ./config/kafka-consumer/kafka-consumer.py:/app/kafka-consumer.py:ro
      - kafka-consumer-output:/app/output
    networks:
      - cdc-network

  # Init container to fix Debezium volume permissions (Debezium runs as UID 185)
  debezium-init:
    image: busybox:1.36
    profiles: ["full"]
    command: ["sh", "-c", "chown -R 185:185 /debezium/data && chmod 755 /debezium/data"]
    volumes:
      - debezium-data:/debezium/data
    restart: "no"

  jmx-exporter:
    image: sscaling/jmx-prometheus-exporter:0.12.0
    profiles: ["full"]
    depends_on:
      - dbz
    environment:
      - SERVICE_PORT=9404
      - CONFIG_YML=/etc/jmx-exporter/config.yaml
    volumes:
      - ./config/jmx-exporter/config.yaml:/etc/jmx-exporter/config.yaml:ro
    networks:
      - cdc-network

  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    profiles: ["full"]
    depends_on:
      kafka:
        condition: service_healthy
    command:
      - --kafka.server=kafka:9092
    networks:
      - cdc-network

  # OpenLogReplicator - feeds Debezium via OLR adapter
  olr-dbz:
    build: ./olr
    profiles: ["full"]
    depends_on:
      init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
    volumes:
      - oracle-oradata:/opt/oracle/oradata:ro
      - ./config/openlogreplicator/OpenLogReplicator.json:/opt/OpenLogReplicator/scripts/OpenLogReplicator.json:ro
      - olr:/olr
    networks:
      cdc-network:
        aliases:
          - olr

  # Debezium with OpenLogReplicator backend
  dbz:
    image: quay.io/debezium/server:3.0.6.Final
    profiles: ["full"]
    restart: on-failure
    depends_on:
      debezium-init:
        condition: service_completed_successfully
      oracle:
        condition: service_healthy
      kafka:
        condition: service_healthy
      olr-dbz:
        condition: service_started
    environment:
      - JAVA_OPTS=-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=1099 -Dcom.sun.management.jmxremote.rmi.port=1099 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=dbz
    volumes:
      - ./config/debezium/application-olr.properties:/debezium/config/application.properties:ro
      - debezium-data:/debezium/data
    networks:
      - cdc-network

volumes:
  oracle-oradata:
  prometheus-data:
  olr:
  hammerdb-output:
  # Full profile volumes
  kafka-data:
  debezium-data:
  kafka-consumer-output:

networks:
  cdc-network:
    driver: bridge
